---
output: github_document
always_allow_html: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)
library(vpstheme)
library(geomtextpath)
library(kableExtra)
```

```{r update_sqwiggle, include=FALSE}

source("~/sqwiggle/sqwiggle_2025.R")
source("~/sqwiggle/generate_tips.R")
source("~/sqwiggle/build_ladder.R")

```

# Sqwiggle

## Introduction

<!-- badges: start -->

<!-- badges: end -->

Sqwiggle is a simple [ELO](https://cran.r-project.org/web/packages/fitzRoy/vignettes/elo-ratings-example.html) model for predicting [AFLW](https://www.afl.com.au/aflw) results built in R using the [fitzRoy](https://cran.r-project.org/web/packages/fitzRoy/index.html) and [elo](https://cran.r-project.org/web/packages/elo/index.html) packages. The name is derived from [Squiggle](https://squiggle.com.au/).

## A better ladder

A key motivation for Sqwiggle was to better understand the state of play in the AFLW, which is an uneven competition with a compromised fixture.

-   As the eighteen teams in the AFLW only play 12 games, whether a team is drawn against stronger or weaker opponents will be critical in determining the final ladder.

-   Similarly, whether the current ladder is reflective of the likely finishing positions will depend on whether a team's draw to date has been stronger/weaker than its overall fixture.

We can see this reflected in the table below, which shows data from the current ladder and a predicted end-of-season ladder based on Sqwiggle. While both ladders have North Melbourne sitting on top undefeated, other teams shift position.

\- GWS, who sit `r combined_ladder |> filter(str_detect(team_club_name,"GWS")) |>  pull(position_current) |>  toOrdinal::toOrdinal()` are predicted by Sqwiggle to win `r combined_ladder |> filter(str_detect(team_club_name,"GWS")) |> pull(wins_predicted) - combined_ladder |> filter(str_detect(team_club_name, "GWS")) |> pull(wins_current)` of their remaining games and finish `r combined_ladder |> filter(str_detect(team_club_name,"GWS")) |>  pull(position_predicted) |>  toOrdinal::toOrdinal()`.

\- Hawthorn, who sit `r combined_ladder |> filter(str_detect(team_club_name,"Hawthorn")) |>  pull(position_current) |>  toOrdinal::toOrdinal()` and are predicted to hold that position benefit from upsetting Brisbane in the opening round and a weaker draw (opposition strength of `r combined_ladder |> filter(str_detect(team_club_name,"Hawthorn")) |>  pull(opposition_strength)`) as Sqwiggle only ranks them as the `r combined_ladder |> filter(str_detect(team_club_name,"Hawthorn")) |>  pull(position_model) |>  toOrdinal::toOrdinal()` best team.

\- Port Adelaide are predicted to finish `r combined_ladder |> filter(str_detect(team_club_name,"Port")) |>  pull(position_predicted) |>  toOrdinal::toOrdinal()` even though Sqwiggle ranks them as the `r combined_ladder |> filter(str_detect(team_club_name,"Port")) |>  pull(position_model) |>  toOrdinal::toOrdinal()` best team as they have the toughest draw (opposition strength of `r combined_ladder |> filter(str_detect(team_club_name,"Port")) |>  pull(opposition_strength)`).


```{r ladder_sqwiggle, echo=FALSE}

combined_ladder |>
  rename_with(\(x) str_replace_all(x,"_|club", " ") |> str_to_sentence()) |> 
  knitr::kable() |> 
   kable_styling()  |> 
   row_spec(1:8, background = bv.crystal) |> 
   row_spec(9:18, background = bv.white)

```
*Roo test denotes a team plays North Melbourne - the highest ranked team and prediced to be undefeated. Notably, Hawthorn has the second lowest opposition strength score despite playing North Melbourne.


## Team strength

As an ELO model, Sqwiggle's assessment of teams and predictive ability is based on past performance. Sqwiggle learns as each round is played. Sqwiggle was also updated after round 4 to account for distance travelled when calculating home ground advantage. All data below is derived from this new model.

Sqwiggle's estimate of each team's ELO score after each round is shown below (round zero denotes the team's end of 2024 score).

```{r sqwiggle_wiggle, echo=FALSE, out.width = 2000, out.height = 1000}

suppressWarnings(
  ggplot(
    data = sqwiggles_2025 |> mutate(ymin = 1500, xmin = 0),
    aes(
      x = round_number, 
      y = value, 
      xmax = round_number, 
      ymax = value, 
      ymin = ymin, 
      xmin = xmin, 
      colour = team_club_name, 
      label = team_club_name, 
      fill = team_club_name)
  ) +
  geom_hline(
    yintercept = 1500, 
    colour = bv.charcoal, 
    linetype  = 2) +
  geom_line() +
  geom_ribbon(outline.type = "upper") +
#  ggrepel::geom_text_repel(
#    data = sqwiggles_2025 |> filter(round_number==3) |> 
#      mutate(round_number = round_number + .01),
#    hjust = 0,
#    size = 3,
#    direction = "y"
 # ) +
  theme_vps_dh(base_size = 7) +
  facet_wrap(
    facets = vars(team_club_name),
    ncol = 6,
    strip.position = "top") +
  scale_y_continuous(
    limits = c(1410,1630),
    breaks = seq(1400,1600,by = 50),
    name = "Sqwiggle score") +
  scale_x_continuvps(
    breaks = 1L:18L, 
    name = NULL, limits = c(0,last_round+.1)) +
  scale_colour_manual(
   values = unlist(team_colours))+
  scale_fill_manual(
    values = alpha(unlist(team_colours),.5))+
  guides(
    colour = "none", fill = "none") +
  labs(
    caption = "Note: 1500 is the base score in Sqwiggle.")+
  theme(
    axis.line.x = element_blank(),
    strip.placement = "inside")
)
```

## How well does Sqwiggle go at tipping

Sqwiggle's tipping performance for 2025 is summarised below. As of round `r last_round` it would be leading [The Age's expert tips competition](https://www.theage.com.au/sport/afl/aflw-expert-tips-20250814-p5mn1s.html) and would be top ten in [ESPN's footy tips competition](https://www.footytips.com.au/competitions/aflw/ladders?view=ladderScores&season=747&competitionId=706852)

```{r summarise_sqwiggle, echo=FALSE}

tipping_results |> 
  group_by(round_round_number) |> 
  summarise(correct = sum(correct), games = n()) |> 
  mutate(cumulative = cumsum(correct)) |> 
  rename_with(
    \(x) str_replace_all(x,"round_|_|club_name", " ")
    |> str_to_sentence()) |> 
  knitr::kable() |> 
   kable_styling() 

```

Sqwiggles tips for the next round are below.

```{r tipped_by_sqwiggle, echo=FALSE}

tip_tbl |> 
  filter(round_round_number == (last_round+1L)) |> 
  mutate(home_game_advantage=round(home_game_advantage)) |> 
  rename_with(
    \(x) str_replace_all(x,"round_number|_|club_name", " ")
    |> str_to_sentence()) |> 
  knitr::kable() |> 
  kable_styling()

```
